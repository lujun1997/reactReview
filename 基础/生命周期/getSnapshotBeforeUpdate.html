<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>getSnapshotBeforeUpdate</title>
</head>
<style>
  ul{
    width: 200px;
    height: 120px;
    background-color: antiquewhite;
    overflow-y: scroll;
  }
  li{
    height: 40px;
    background-color: beige;
  }
</style>
<body>
    <!-- 注意: 部署时，将 "development.js" 替换为 "production.min.js"。-->
    <script src="https://unpkg.com/react/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom/umd/react-dom.development.js" crossorigin></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.20.4/babel.min.js"></script>
    <div id="root"></div>
    <script type="text/babel">
      class ScrollingList extends React.Component {
          constructor(props) {
            super(props);
            this.state={
              list:[],
              value:0
            }
            this.listRef = React.createRef();
          }

          getSnapshotBeforeUpdate(prevProps, prevState) {
            // 我们是否在 list 中添加新的 items ？
            // 捕获滚动​​位置以便我们稍后调整滚动位置。

            console.log('-----', prevState, this)
            if (prevState.list.length < this.state.list.length) {
              const list = this.listRef.current;
              console.log(list, 'list111')
              console.log(list.scrollHeight - list.scrollTop, '===')
              return list.scrollHeight - list.scrollTop;
            }
            return null;
          }
          componentDidMount(){
            setInterval(() => {
            const {list} = this.state;

              console.log(111, list)
              this.setState({
                list:[list.length+1, ...list,]
              })
            }, 1000);
            setInterval(() => {
            const {value} = this.state;
            if(value>100) return

              this.setState({
                value:value+1
              })
            }, 16);
          }

          componentDidUpdate(prevProps, prevState, snapshot) {
            // 如果我们 snapshot 有值，说明我们刚刚添加了新的 items，
            // 调整滚动位置使得这些新 items 不会将旧的 items 推出视图。
            //（这里的 snapshot 是 getSnapshotBeforeUpdate 的返回值）
            if (snapshot !== null) {
              const list = this.listRef.current;
              console.log('result', list.scrollHeight - snapshot)
              list.scrollTop = list.scrollHeight - snapshot;
            }
          }

          render() {
            return (
              <div ref={this.listRef}>
                <span>test <sup>333</sup></span>
                {this.state.value < 100 && <meter
  min="0"
  max="100"
  low="25"
  high="75"
  optimum="80"
  value={this.state.value}
></meter>}
<meta
  http-equiv="refresh"
  content="3; url=https://juejin.cn/"
/>
                <ul>
                  {
                    this.state.list.map((item, index) => {
                      return <li key={index}>{item}</li>
                    })
                  }  
                </ul>
              </div>
            );
          }
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ScrollingList/>);
    </script>
</body>
</html>